<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Setup a Circuit Breaker with Hystrix, Feign Client and Spring Boot</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="Entrepreneur, consultant, bio-sciences and software engineer."><meta name=author content="Nadia Humbert-Labeaumaz"><meta name=generator content="Hugo 0.82.1"><meta property="og:image" content="https://nadia-humbert-labeaumaz.github.io/images/blog/circuit-breaker/header.jpg"><meta property="og:title" content="Setup a Circuit Breaker with Hystrix, Feign Client and Spring Boot"><meta property="og:description" content="In a microservices architecture, several things can go wrong. A middleware, the network or the service you want to contact can be down. In this world of uncertainty, you have to anticipate problems in order not to break the entire chain and throw an error to the end user when you could offer a partially degraded service instead.
The goal of this article is to show how to implement the circuit breaker pattern using Hystrix, Feign Client and Spring Boot."><meta property="og:type" content="article"><meta property="og:url" content="https://nadia-humbert-labeaumaz.github.io/blog/2017/07/23/setup-a-circuit-breaker-with-hystrix/"><meta property="og:image" content="https://nadia-humbert-labeaumaz.github.io/images/slider.jpg"><meta property="article:section" content="blog"><meta property="article:published_time" content="2017-07-23T13:33:38+02:00"><meta property="article:modified_time" content="2017-07-23T13:33:38+02:00"><meta property="og:site_name" content="Nadia Humbert-Labeaumaz"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://nadia-humbert-labeaumaz.github.io/images/slider.jpg"><meta name=twitter:title content="Setup a Circuit Breaker with Hystrix, Feign Client and Spring Boot"><meta name=twitter:description content="In a microservices architecture, several things can go wrong. A middleware, the network or the service you want to contact can be down. In this world of uncertainty, you have to anticipate problems in order not to break the entire chain and throw an error to the end user when you could offer a partially degraded service instead.
The goal of this article is to show how to implement the circuit breaker pattern using Hystrix, Feign Client and Spring Boot."><script async src="https://www.googletagmanager.com/gtag/js?id=G-FDXGPB3FE3"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-FDXGPB3FE3',{anonymize_ip:!1})}</script><link rel=stylesheet href=/plugins/bootstrap/css/bootstrap.min.css media=screen><link rel=stylesheet href=/plugins/ionicons/css/ionicons.min.css><link rel=stylesheet href=/plugins/magnific-popup/magnific-popup.min.css><link rel=stylesheet href=/plugins/slick/slick.css><link rel=stylesheet href=/scss/style.min.css media=screen><link rel="shortcut icon" href=/images/favicon.png type=image/x-icon><link rel=icon href=/images/favicon.png type=image/x-icon></head><body><div class=preloader></div><header class=navigation><div class=container-fluid><div class=row><div class=col-md-12><nav class=navbar><div class=navbar-header><button type=button class="navbar-toggle collapsed" data-toggle=collapse data-target=#navigation>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button></div><div class="collapse navbar-collapse" id=navigation><ul class="nav navbar-nav navbar-right"><li><a href=/>Home</a></li><li><a href=/about>About</a></li><li><a href=/experience>Experience</a></li><li><a href=/blog>Blog</a></li><li><a href=/categories/case-studies>Case Studies</a></li><li class=dropdown><a href=# class=dropdown-toggle data-toggle=dropdown role=button aria-haspopup=true aria-expanded=false>Crafties <span class=ion-ios-arrow-down></span></a><ul class=dropdown-menu><li><a href=/crafties>Videos</a></li><li><a href=/drafties>Drafties</a></li><li><a href=/talks>Talks</a></li></ul></li><li class=dropdown><a href=# class=dropdown-toggle data-toggle=dropdown role=button aria-haspopup=true aria-expanded=false>Social Impact Guild <span class=ion-ios-arrow-down></span></a><ul class=dropdown-menu><li><a href=https://blog.socialimpactguild.com>Blog</a></li><li><a href=https://www.youtube.com/channel/UCyZZjLr31BF_o_mJINm5AlA>Videos</a></li></ul></li></ul></div></nav></div></div></div></header><section class="page-title bg-2" style=background-image:url(/images/blog/circuit-breaker/header.jpg)><div class=container><div class=row><div class=col-md-12><div class=block><h1>Setup a Circuit Breaker with Hystrix, Feign Client and Spring Boot</h1><p></p></div></div></div></div></section><section class=page-wrapper><div class=container><div class=row><div class=col-md-8><div class="post post-single"><h2 class=post-title>Setup a Circuit Breaker with Hystrix, Feign Client and Spring Boot</h2><div class=post-meta><ul><li><i class=ion-calendar></i> July 23, 2017</li><li><i class=ion-android-people></i>
Posted by
<a class=text-primary href=/author/nadia-humbert-labeaumaz>Nadia Humbert-Labeaumaz</a></li><li><i class=ion-pricetags></i>
<a href=/tags/java>Java</a>, <a href=/tags/software-design>Software Design</a></li></ul></div><div class=post-thumb><img class=img-responsive src=/images/blog/circuit-breaker/header.jpg alt="Setup a Circuit Breaker with Hystrix, Feign Client and Spring Boot"></div><div class="post-content post-excerpt"><p>In a microservices architecture, several things can go wrong. A middleware, the network or the service you want to contact can be down. In this world of uncertainty, you have to anticipate problems in order not to break the entire chain and throw an error to the end user when you could offer a partially degraded service instead.</p><p>The goal of this article is to show how to implement the circuit breaker pattern using Hystrix, Feign Client and Spring Boot.</p><h2 id=feign-client-crash-course>Feign Client Crash Course</h2><p><a href=https://github.com/OpenFeign/feign>Feign</a> is an HTTP client created by Netflix to make HTTP communications easier. It is integrated to Spring Boot with the <code>spring-cloud-starter-feign</code> starter.</p><p>To create a client to consume an HTTP service, an interface annotated with <code>@FeignClient</code> must be created. Endpoints can be declared in this interface using an API that is very close to the Spring MVC API. The <code>@EnableFeignClients</code> annotation must also be added to a Spring Configuration class.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@Configuration</span>
<span style=color:#a6e22e>@EnableFeignClients</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FeignConfiguration</span> <span style=color:#f92672>{</span>

<span style=color:#f92672>}</span>
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@FeignClient</span><span style=color:#f92672>(</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;videos&#34;</span><span style=color:#f92672>,</span> url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http://localhost:9090/videos&#34;</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>VideoClient</span> <span style=color:#f92672>{</span>

    <span style=color:#a6e22e>@PostMapping</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/api/videos/suggest&#34;</span><span style=color:#f92672>)</span>
    List<span style=color:#f92672>&lt;</span>Suggestion<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>suggest</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestBody</span> ViewingHistory history<span style=color:#f92672>);</span>

<span style=color:#f92672>}</span>
</code></pre></div><p>An instance of <code>VideoClient</code> is automagically injected into the Spring application context and can be autowired and used throughout the application. Moreover, if the <code>videos</code> microservice is registred to the same discovery service as the current microservice, there is no need for an URL as it will be retrieved for you based on the <code>name</code>.</p><p>If the <code>videos</code> service, a middleware or the network happens to be down or overloaded, the <code>suggest</code> method will throw a <code>FeignException</code> that will be propagated throughout the stack if not caught.</p><h2 id=create-a-fallback-implementation>Create a Fallback Implementation</h2><p>Fortunately, Spring Cloud comes with a solution to this problem: a circuit breaker. In this article, we will use <a href=https://github.com/Netflix/Hystrix>Hystrix</a>. It is also created by Netflix and also integrated to Spring Boot using the <code>spring-cloud-starter-hystrix</code> starter.</p><p>The idea is to create an implementation of the <code>VideoClient</code> and mark it as the default behaviour if <code>videos</code> is unreachable or overloaded. Like a lot of other Spring features, it is enabled using an annotation: <code>@EnableCircuitBreaker</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@Configuration</span>
<span style=color:#a6e22e>@EnableFeignClients</span>
<span style=color:#a6e22e>@EnableCircuitBreaker</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FeignConfiguration</span> <span style=color:#f92672>{</span>

<span style=color:#f92672>}</span>
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@FeignClient</span><span style=color:#f92672>(</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;videos&#34;</span><span style=color:#f92672>,</span> url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http://localhost:9090/videos&#34;</span><span style=color:#f92672>,</span> fallback <span style=color:#f92672>=</span> VideoClientFallback<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>VideoClient</span> <span style=color:#f92672>{</span>

    <span style=color:#a6e22e>@PostMapping</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/api/videos/suggest&#34;</span><span style=color:#f92672>)</span>
    List<span style=color:#f92672>&lt;</span>Suggestion<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>suggest</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestBody</span> ViewingHistory history<span style=color:#f92672>);</span>

<span style=color:#f92672>}</span>
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@Component</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>VideoClientFallback</span> <span style=color:#66d9ef>implements</span> VideoClient <span style=color:#f92672>{</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>Suggestion<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>suggest</span><span style=color:#f92672>(</span>ViewingHistory history<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
      <span style=color:#75715e>// Degraded service: no suggestion to offer
</span><span style=color:#75715e></span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;();</span>
    <span style=color:#f92672>}</span>

<span style=color:#f92672>}</span>
</code></pre></div><p>A configuration property has to be added to the <code>application.yml</code> file of the Spring Boot application to tell Feign to enable Hystrix.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#f92672>feign</span>:
    <span style=color:#f92672>hystrix</span>:
        <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</code></pre></div><p>Voila! Every time the remote service will be unavailable, the <code>suggest</code> method of the <code>VideoClientFallback</code> will be called and the end user will not get an error violently thrown at her.</p><h2 id=keep-track-of-the-source-error>Keep Track of the Source Error</h2><p>With this setup, the fallback will be called regardless of the initial error that will be swallowed. If you want to retrieve this error and do something with it, you can use a <code>FallbackFactory</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@FeignClient</span><span style=color:#f92672>(</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;videos&#34;</span><span style=color:#f92672>,</span> url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http://localhost:9090/videos&#34;</span><span style=color:#f92672>,</span> fallbackFactory <span style=color:#f92672>=</span> VideoClientFallbackFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>VideoClient</span> <span style=color:#f92672>{</span>

  <span style=color:#a6e22e>@PostMapping</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/api/videos/suggest&#34;</span><span style=color:#f92672>)</span>
  List<span style=color:#f92672>&lt;</span>Suggestion<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>suggest</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestBody</span> ViewingHistory history<span style=color:#f92672>);</span>

<span style=color:#f92672>}</span>
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@Component</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>VideoClientFallbackFactory</span> <span style=color:#66d9ef>implements</span> FallbackFactory<span style=color:#f92672>&lt;</span>VideoClient<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> VideoClient <span style=color:#a6e22e>create</span><span style=color:#f92672>(</span>Throwable throwable<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> VideoClientFallback<span style=color:#f92672>(</span>throwable<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>

<span style=color:#f92672>}</span>
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>VideoClientFallback</span> <span style=color:#66d9ef>implements</span> VideoClient <span style=color:#f92672>{</span>

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Throwable cause<span style=color:#f92672>;</span>

    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>VideoClientFallback</span><span style=color:#f92672>(</span>Throwable cause<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
      <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>cause</span> <span style=color:#f92672>=</span> cause<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>Suggestion<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>suggest</span><span style=color:#f92672>(</span>ViewingHistory history<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>cause <span style=color:#66d9ef>instanceof</span> FeignException <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>((</span>FeignException<span style=color:#f92672>)</span> cause<span style=color:#f92672>).</span><span style=color:#a6e22e>status</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> 404<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#75715e>// Treat the HTTP 404 status
</span><span style=color:#75715e></span>        <span style=color:#f92672>}</span>

        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;();</span>
    <span style=color:#f92672>}</span>

<span style=color:#f92672>}</span>
</code></pre></div><h2 id=conclusion>Conclusion</h2><p>Microservices foster low coupling between components and resiliency. Hence, it would be sad to throw an error every time a service or a middleware is down. The circuit breaker pattern explained in this article allows you to ensure the continuity of service, even if it has to be offered in a degraded manner. As always, Spring Boot is a great help to setup this mechanism very easily.</p></div><div class=post-comments></div></div></div><div class=col-md-4><aside class=sidebar><div class="widget widget-latest-post"><h4 class=widget-title>Latest Posts</h4><div class=media><a class=pull-left href=/blog/2021/04/28/effecting-long-lasting-changes/><img class=media-object src=/images/blog/effecting-long-lasting-changes/header.jpg alt="How to Effect Long-Lasting Organizational Changes?"></a><div class=media-body><h4 class=media-heading><a href=/blog/2021/04/28/effecting-long-lasting-changes/>How to Effect Long-Lasting Organizational Changes?</a></h4></div></div><div class=media><a class=pull-left href=/blog/2021/01/14/what-is-a-social-entrepreneur/><img class=media-object src=/images/blog/what-is-a-social-entrepreneur/header.jpg alt="What is a Social Entrepreneur?"></a><div class=media-body><h4 class=media-heading><a href=/blog/2021/01/14/what-is-a-social-entrepreneur/>What is a Social Entrepreneur?</a></h4></div></div><div class=media><a class=pull-left href=/blog/2020/07/05/debt-sme-nz/><img class=media-object src=/images/blog/debt-sme-nz/header.jpg alt="Debt and SMEs in New Zealand"></a><div class=media-body><h4 class=media-heading><a href=/blog/2020/07/05/debt-sme-nz/>Debt and SMEs in New Zealand</a></h4></div></div><div class=media><a class=pull-left href=/blog/2020/02/13/transformation-assessment/><img class=media-object src=/images/blog/transformation-assessment/header.jpg alt="Assessment of XYZ’s IT Business Unit Transformation"></a><div class=media-body><h4 class=media-heading><a href=/blog/2020/02/13/transformation-assessment/>Assessment of XYZ’s IT Business Unit Transformation</a></h4></div></div></div><div class="widget widget-category"><h4 class=widget-title>Categories</h4><ul class=widget-category-list><li><a href=/categories/business/>Business</a></li><li><a href=/categories/case-studies/>Case Studies</a></li><li><a href=/categories/software/>Software</a></li></ul></div><div class="widget widget-tag"><h4 class=widget-title>Tags</h4><ul class=widget-tag-list><li><a href=/tags/change-management/>Change Management</a></li><li><a href=/tags/economics/>Economics</a></li><li><a href=/tags/finance/>Finance</a></li><li><a href=/tags/java/>Java</a></li><li><a href=/tags/operational-excellence/>Operational Excellence</a></li><li><a href=/tags/refactoring/>Refactoring</a></li><li><a href=/tags/social-entrepreneurship/>Social Entrepreneurship</a></li><li><a href=/tags/software-design/>Software Design</a></li><li><a href=/tags/software-testing/>Software Testing</a></li></ul></div></aside></div></div></div></section><footer class=footer><div class=container><div class=row><div class=col-md-12><div class=footer-menu><ul><li><a href=/>Home</a></li><li><a href=/about>About</a></li><li><a href=/experience>Experience</a></li><li><a href=/blog>Blog</a></li><li><a href=/categories/case-studies>Case Studies</a></li></ul></div><div class=footer-menu><ul><li><a href=https://www.linkedin.com/in/nadia-humbert-labeaumaz/><i class=ion-social-linkedin-outline></i></a></li><li><a href=https://twitter.com/nphumbert><i class=ion-social-twitter-outline></i></a></li></ul></div><p class=copyright>Nadia Humbert-Labeaumaz • 2021</p></div></div></div></footer><script src=/plugins/jquery/jquery.min.js></script><script src=/plugins/bootstrap/js/bootstrap.min.js></script><script src=/plugins/slick/slick.min.js></script><script src=/plugins/magnific-popup/magnific-popup.min.js></script><script src=/plugins/shuffle/shuffle.min.js></script><script src=/plugins/google-map/gmap.js defer></script><script src=/js/script.min.js></script></body></html>